<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="JavaScript,"><meta name="description" content="上周使用了 Immer 帮助我更新 redux state 对于萌新的我来说非常好用,粗略的看了一下源码,感觉很简单,尝试进行学习一下"><meta name="keywords" content="JavaScript"><meta property="og:type" content="article"><meta property="og:title" content="Immer源码学习"><meta property="og:url" content="https://github.com/HiMrHu/H.git/2018/07/22/Immer源码学习/index.html"><meta property="og:site_name" content="胡先生"><meta property="og:description" content="上周使用了 Immer 帮助我更新 redux state 对于萌新的我来说非常好用,粗略的看了一下源码,感觉很简单,尝试进行学习一下"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2020-05-04T05:06:36.931Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Immer源码学习"><meta name="twitter:description" content="上周使用了 Immer 帮助我更新 redux state 对于萌新的我来说非常好用,粗略的看了一下源码,感觉很简单,尝试进行学习一下"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://github.com/HiMrHu/H.git/2018/07/22/Immer源码学习/"><title>Immer源码学习 | 胡先生</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">胡先生</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://github.com/HiMrHu/H.git/2018/07/22/Immer源码学习/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="H"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="胡先生"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Immer源码学习</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-22T12:27:24+00:00">2018-07-22</time></span></div></header><div class="post-body" itemprop="articleBody"><p>上周使用了 Immer 帮助我更新 redux state 对于萌新的我来说非常好用,粗略的看了一下源码,感觉很简单,尝试进行学习一下</p><a id="more"></a><h1 id="Immer-简介"><a href="#Immer-简介" class="headerlink" title="Immer 简介"></a>Immer 简介</h1><p>Immer 说明文件中,简介明了的说明了自己的用处:</p><blockquote><p>通过简单的修改当前的状态树来创建下一个不可变的状态树</p></blockquote><p>Immer 暴露了一个可以完成所有工作的默认函数,函数签名如下:</p><p><code>produce(currentState, producer: (draftState) =&gt; void): nextState</code></p><p>同时它还有一个柯里化后的重载</p><p>这个库用起来非常简单</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> produce <span class="keyword">from</span> <span class="string">"immer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baseState = [</span><br><span class="line">  &#123;</span><br><span class="line">    todo: <span class="string">"Learn typescript"</span>,</span><br><span class="line">    done: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    todo: <span class="string">"Try immer"</span>,</span><br><span class="line">    done: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nextState = produce(baseState, draftState =&gt; &#123;</span><br><span class="line">  draftState.push(&#123; <span class="attr">todo</span>: <span class="string">"Tweet about it"</span> &#125;);</span><br><span class="line">  draftState[<span class="number">1</span>].done = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>函数 produce 接收两个参数, 第一个参数是当前的状态树,第二个参数是一个函数,函数接受一个参数,可以对这个参数进行修改,直接赋值即可,最后 produce 函数返回的就是一个新的状态树(不需要 return)</p><p>从 Immer 库中开始看</p><h1 id="柯里化准备和参数判断"><a href="#柯里化准备和参数判断" class="headerlink" title="柯里化准备和参数判断"></a>柯里化准备和参数判断</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;setAutoFreeze, setUseProxies&#125; <span class="keyword">from</span> <span class="string">"./common"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;isProxyable, getUseProxies&#125; <span class="keyword">from</span> <span class="string">"./common"</span></span><br><span class="line"><span class="keyword">import</span> &#123;produceProxy&#125; <span class="keyword">from</span> <span class="string">"./proxy"</span></span><br><span class="line"><span class="keyword">import</span> &#123;produceEs5&#125; <span class="keyword">from</span> <span class="string">"./es5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * produce 得到一个 state, 并且针对它运行一个函数.</span></span><br><span class="line"><span class="comment"> * 这个函数可以自由的改变这个 state, 因为它基于 copies-on-write(写入时赋值)的机制.</span></span><br><span class="line"><span class="comment"> * 这意味着原始状态将保持不变,一旦函数运行完毕,它将返回修改后的状态</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@export</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;any&#125;</span> <span class="variable">baseState</span></span> - 原始的 state</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> <span class="variable">producer</span></span> - 一个函数接受一个基本 state 代理并且可以自由修改它的函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;any&#125;</span> </span>新的 state, 如果没有修改 state 的话就返回 baseState</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">produce</span>(<span class="params">baseState, producer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 检查函数参数,预期得到1个或者两个参数,如果不是一个或者两个则抛出错误</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">arguments</span>.length !== <span class="number">1</span> &amp;&amp; <span class="built_in">arguments</span>.length !== <span class="number">2</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"produce expects 1 or 2 arguments, got "</span> + <span class="built_in">arguments</span>.length)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// curried invocation 判断第一个函数是否为函数,如果是函数那么就是柯里化调用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> baseState === <span class="string">"function"</span>) &#123;</span><br><span class="line">        <span class="comment">// prettier-ignore 如果第一个参数是一个函数,那么就是柯里化调用,则第二个函数必定不能为函数(如果第一个参数为函数,第二个参数可以为数组或者对象,作为初始化状态)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> producer === <span class="string">"function"</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"if first argument is a function (curried invocation), the second argument to produce cannot be a function"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> initialState = producer <span class="comment">// 储存柯里化调用的初始化状态</span></span><br><span class="line">        <span class="keyword">const</span> recipe = baseState <span class="comment">// 储存函数</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 返回一个匿名函数</span></span><br><span class="line">            <span class="keyword">const</span> args = <span class="built_in">arguments</span> <span class="comment">// 声明一个变量储存参数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> currentState = <span class="comment">// 三元表达判断一下是否传入了第一个参数和第二个参数</span></span><br><span class="line">                args[<span class="number">0</span>] === <span class="literal">undefined</span> &amp;&amp; initialState !== <span class="literal">undefined</span></span><br><span class="line">                    ? initialState <span class="comment">// 如果第一个参数为未定义,第二个参数存在则返回第二个参数(即初始化状态)</span></span><br><span class="line">                    : args[<span class="number">0</span>] <span class="comment">// 否则就返回第一个参数(上面已经判断了至少要有一个参数)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> produce(currentState, draft =&gt; &#123; <span class="comment">// 上面收集到相关数据了,这里就进行调用</span></span><br><span class="line">            <span class="comment">// 转变为普通调用 produce(当前state, 可以修改的state)</span></span><br><span class="line">                args[<span class="number">0</span>] = draft <span class="comment">// blegh!</span></span><br><span class="line">                <span class="keyword">return</span> recipe.apply(draft, args)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prettier-ignore</span></span><br><span class="line">    <span class="comment">// 如果第一个参数不是函数,那么就不是柯里化,第二个参数必然是函数</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> producer !== <span class="string">"function"</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"if first argument is not a function, the second argument to produce should be a function"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if state is a primitive, don't bother proxying at all</span></span><br><span class="line">    <span class="comment">// 如果 原始数据不是数组或者对象,或者为空就不需要代理了</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> baseState !== <span class="string">"object"</span> || baseState === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> returnValue = producer(baseState)</span><br><span class="line">        <span class="keyword">return</span> returnValue === <span class="literal">undefined</span> ? baseState : returnValue</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里调用函数判断原始对象是否为代理对象(就判断他是否为原始JavaScript数组和对象)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * isProxyable 接收一个接受一个值作为参数 判断值是否为原始数据类型</span></span><br><span class="line"><span class="comment">     * 其中判断了值是否为空</span></span><br><span class="line"><span class="comment">     * 调用typeof判断值是否为 'object' (原始数据类型)</span></span><br><span class="line"><span class="comment">     * 调用isArray 判断是否为数组</span></span><br><span class="line"><span class="comment">     * 调用 Object.getPrototypeOf 判断值的原型 是否为空 和 是否等于 object的原型(判断是否为原始对象,数组上面判断过了)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isProxyable(baseState)) <span class="comment">// 如果不是原始对象那么就抛出错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">            <span class="string">`the first argument to an immer producer should be a primitive, plain object or array, got <span class="subst">$&#123;<span class="keyword">typeof</span> baseState&#125;</span>: "<span class="subst">$&#123;baseState&#125;</span>"`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * `getUseProxies 函数判断当前环境是否存在 Proxy 如果存在就使用 Proxy 如果不存在就使用es5方案</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">return</span> getUseProxies()</span><br><span class="line">        ? produceProxy(baseState, producer)</span><br><span class="line">        : produceEs5(baseState, producer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>阅读文档说明得知 Immer 支持比较旧的 JavaScript 环境, 在比较新的环境下使用性能好的 Proxy ,在比较旧的环境下使用另一种方案先看看 Proxy 方案</p><h1 id="Proxy-方案实现"><a href="#Proxy-方案实现" class="headerlink" title="Proxy 方案实现"></a>Proxy 方案实现</h1><p>代码如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">produceProxy</span>(<span class="params">baseState, producer</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  isProxy 判断 baseState 是否为空如果不为空</span></span><br><span class="line"><span class="comment">   *  判断 baseState中是否存在  __$immer_state(symbol不存在) 属性</span></span><br><span class="line"><span class="comment">   *  如果本身已经被代理过了那么直接运行</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">if</span> (isProxy(baseState)) &#123;</span><br><span class="line">        <span class="comment">// See #100, don't nest producers</span></span><br><span class="line">        <span class="comment">// 详见 #100  不要嵌套 producers</span></span><br><span class="line">        <span class="keyword">const</span> returnValue = producer.call(baseState, baseState) <span class="comment">// 调用回调函数,并且将this指向 baseState 本身</span></span><br><span class="line">        <span class="keyword">return</span> returnValue === <span class="literal">undefined</span> ? baseState : returnValue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> previousProxies = proxies <span class="comment">// proxies = null</span></span><br><span class="line">    proxies = []</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// create proxy for root</span></span><br><span class="line">        <span class="comment">// 为 root 创造一个 Proxy</span></span><br><span class="line">        <span class="comment">// createProxy 接收两个参数, 创建一个 proxy代理对象</span></span><br><span class="line">        <span class="keyword">const</span> rootProxy = createProxy(<span class="literal">undefined</span>, baseState)</span><br><span class="line">        <span class="comment">// execute the thunk</span></span><br><span class="line">        <span class="comment">// 执行这个被包装过的对象</span></span><br><span class="line">        <span class="keyword">const</span> returnValue = producer.call(rootProxy, rootProxy)</span><br><span class="line">        <span class="comment">// and finalize the modified proxy</span></span><br><span class="line">        <span class="comment">// 并最终确认修改后的 proxy</span></span><br><span class="line">        <span class="keyword">let</span> result</span><br><span class="line">        <span class="comment">// check whether the draft was modified and/or a value was returned</span></span><br><span class="line">        <span class="comment">// 用于检查 draft 是否已经修改或者返回值</span></span><br><span class="line">        <span class="keyword">if</span> (returnValue !== <span class="literal">undefined</span> &amp;&amp; returnValue !== rootProxy) &#123;</span><br><span class="line">            <span class="comment">// something was returned, and it wasn't the proxy itself</span></span><br><span class="line">            <span class="comment">// 确定返回了一些东西,而不是 proxy 本身</span></span><br><span class="line">            <span class="keyword">if</span> (rootProxy[PROXY_STATE].modified)</span><br><span class="line">            <span class="comment">// 如果没有修改或者没有返回抛出错误</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(RETURNED_AND_MODIFIED_ERROR)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// See #117</span></span><br><span class="line">            <span class="comment">// Should we just throw when returning a proxy which is not the root, but a subset of the original state?</span></span><br><span class="line">            <span class="comment">// Looks like a wrongly modeled reducer</span></span><br><span class="line">            result = finalize(returnValue)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = finalize(rootProxy)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// revoke all proxies</span></span><br><span class="line">        <span class="comment">// 完成之后撤销 Proxy</span></span><br><span class="line">        each(proxies, (_, p) =&gt; p.revoke())</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        proxies = previousProxies</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单的看了一下,发现还是很难,唉还是继续看书吧.</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/JavaScript/" rel="tag"># JavaScript</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/04/22/React详细介绍/" rel="next" title="React详细介绍"><i class="fa fa-chevron-left"></i> React详细介绍</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/08/12/python正则表达式/" rel="prev" title="python正则表达式">python正则表达式<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">H</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">51</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">24</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/HiMrHu" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Immer-简介"><span class="nav-number">1.</span> <span class="nav-text">Immer 简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#柯里化准备和参数判断"><span class="nav-number">2.</span> <span class="nav-text">柯里化准备和参数判断</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Proxy-方案实现"><span class="nav-number">3.</span> <span class="nav-text">Proxy 方案实现</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">H</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html>